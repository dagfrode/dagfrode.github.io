<!DOCTYPE html>
<!--
Equipment Status Page
=====================

Setup Instructions:
1. (Optional) Get a Google Sheets API key:
   - Go to https://console.developers.google.com/
   - Create a new project or select existing
   - Enable the Google Sheets API
   - Create credentials (API key)
   - Copy the API key to CONFIG.API_KEY below

2. Make sure your Google Sheet is published to web:
   - In Google Sheets: File > Share > Publish to web
   - Choose the specific sheet and CSV format
   - Note the GID from the URL for CONFIG.CSV_GID

3. Update the CONFIG section below with your values

Usage:
- Navigate to: page.html?equipment=YourEquipmentName
- Example: page.html?equipment=Patruljetelt%201

Important Notes:
- When running locally (file:// protocol), the page automatically uses CSV method
- For production (https://), you can use either API key method or CSV fallback
- The page works immediately with CSV method - no API key required

Features:
- Uses Google Sheets API if API key is provided and running on https://
- Automatically falls back to CSV export for local development or if no API key
- Mobile-optimized responsive design
- Real-time status display with color indicators
- Direct link to pre-filled form for new entries
-->
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Utstyrsstatus</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .equipment-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .last-updated {
            opacity: 0.9;
            font-size: 14px;
        }
        
        .status-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border: 1px solid #e0e0e0;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .status-dot {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            margin-right: 12px;
        }
        
        .status-dot.ok {
            background-color: #4CAF50;
        }
        
        .status-dot.fault {
            background-color: #f44336;
        }
        
        .status-dot.unknown {
            background-color: #9e9e9e;
        }
        
        .status-text {
            font-size: 18px;
            font-weight: 600;
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 600;
            color: #666;
            font-size: 14px;
        }
        
        .info-value {
            font-weight: bold;
            text-align: right;
            max-width: 60%;
            word-break: break-word;
        }
        
        .fault-section {
            background-color: #fff3e0;
            border: 1px solid #ffcc02;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }
        
        .fault-title {
            font-weight: bold;
            color: #f57c00;
            margin-bottom: 8px;
        }
        
        .fault-text {
            color: #bf360c;
        }
        
        .action-button {
            display: block;
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            text-decoration: none;
            padding: 15px 20px;
            border-radius: 12px;
            text-align: center;
            font-weight: 600;
            font-size: 16px;
            margin-top: 20px;
            transition: transform 0.2s ease;
        }
        
        .action-button:hover {
            transform: translateY(-1px);
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .error {
            background-color: #ffebee;
            border: 1px solid #e57373;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        @media (max-width: 480px) {
            .container {
                padding: 15px;
            }
            
            .header {
                padding: 25px 15px;
            }
            
            .equipment-name {
                font-size: 20px;
            }
            
            .status-card {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="equipment-name" id="equipmentName">Laster utstyr...</div>
            <div class="last-updated" id="lastUpdated">Laster data...</div>
        </div>
        
        <div id="content">
            <div class="loading">
                <p>Laster utstyrsinformasjon...</p>
            </div>
        </div>
    </div>

    <script src="https://apis.google.com/js/api.js"></script>
    <script>
        // Configuration - Update these values for your setup
        const CONFIG = {
            // Google Sheets API Key (optional - will fallback to CSV if not provided)
            // Get your API key from: https://console.developers.google.com/
            API_KEY: 'AIzaSyD2hpUdw78zWKYA0DMtK-TZCXB3JPW_TgI', // Add your Google Sheets API key here
            
            // Spreadsheet configuration
            SPREADSHEET_ID: '14iZgMYd6HZUneDgtz7ytbPBkvxkTBw3p_IHw7X7yXjU',
            SHEET_RANGE: 'Sheet1!A1:K10000', // Adjust range as needed
            CSV_GID: 1618965081, // Sheet GID for CSV fallback
            
            // Form configuration
            FORM_URL: 'https://docs.google.com/forms/d/e/1FAIpQLSehWt6hbh8J3CBtIjF3DYa2WdlZbG5WgVERo6IX6YJ8IhU6Zg/viewform',
            FORM_PREFILL_PARAM: 'entry.1006683374'
        };

        class EquipmentStatus {
            constructor() {
                this.isApiLoaded = false;
                this.init();
            }
            
            init() {
                // Get equipment name from URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                const equipmentName = urlParams.get('equipment') || urlParams.get('utstyr');
                
                if (!equipmentName) {
                    this.showError('Ingen utstyrsnavn spesifisert i URL. Legg til ?equipment=navn');
                    return;
                }
                
                // Set equipment name immediately
                document.getElementById('equipmentName').textContent = equipmentName;
                
                // Initialize Google API and load data
                this.initializeGoogleAPI().then(() => {
                    this.loadEquipmentData(equipmentName);
                }).catch(error => {
                    console.error('Failed to initialize Google API:', error);
                    this.showError('Kunne ikke laste Google Sheets API. Sjekk API-nÃ¸kkel.');
                });
            }
            
            async initializeGoogleAPI() {
                return new Promise((resolve, reject) => {
                    if (this.isApiLoaded) {
                        resolve();
                        return;
                    }
                    
                    // Check if we're running locally (file:// protocol)
                    if (window.location.protocol === 'file:') {
                        console.warn('Running locally (file://), using CSV method to avoid CORS issues');
                        this.fallbackToCSV = true;
                        resolve();
                        return;
                    }
                    
                    // Check if API key is configured
                    if (!CONFIG.API_KEY || CONFIG.API_KEY.trim() === '') {
                        console.warn('No API key configured, using CSV method');
                        this.fallbackToCSV = true;
                        resolve();
                        return;
                    }
                    
                    // Set a timeout for GAPI loading
                    const timeoutId = setTimeout(() => {
                        console.warn('Google API loading timeout, falling back to CSV');
                        this.fallbackToCSV = true;
                        resolve();
                    }, 5000);
                    
                    try {
                        gapi.load('client', async () => {
                            clearTimeout(timeoutId);
                            try {
                                await gapi.client.init({
                                    apiKey: CONFIG.API_KEY,
                                    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
                                });
                                this.isApiLoaded = true;
                                console.log('Google Sheets API initialized successfully');
                                resolve();
                            } catch (error) {
                                console.warn('Failed to initialize Google API, falling back to CSV:', error);
                                this.fallbackToCSV = true;
                                resolve(); // Don't reject, just fall back
                            }
                        });
                    } catch (error) {
                        clearTimeout(timeoutId);
                        console.warn('Failed to load Google API, falling back to CSV:', error);
                        this.fallbackToCSV = true;
                        resolve();
                    }
                });
            }
            
            async loadEquipmentData(equipmentName) {
                try {
                    let data;
                    
                    if (this.fallbackToCSV || !this.isApiLoaded) {
                        // Fallback to CSV method
                        console.log('Using CSV method to fetch data');
                        data = await this.fetchDataFromCSV();
                    } else {
                        // Use Google Sheets API
                        console.log('Using Google Sheets API to fetch data');
                        data = await this.fetchDataFromAPI();
                    }
                    
                    if (!data || data.length === 0) {
                        this.showError('Ingen data funnet i regnearket');
                        return;
                    }
                    
                    console.log('Data loaded:', data.length, 'rows');
                    
                    // Find the latest entry for this equipment
                    const equipmentEntries = data.filter(row => {
                        // Check various possible column names for equipment name
                        const possibleNames = [
                            row['Utstyrsnavn'] || '',
                            row['Navn'] || '',
                            row['Equipment'] || '',
                            row['Item'] || '',
                            Object.values(row)[0] || '' // First column
                        ];
                        
                        return possibleNames.some(name => 
                            name.toLowerCase().trim() === equipmentName.toLowerCase().trim()
                        );
                    });
                    
                    console.log('Found entries for equipment:', equipmentEntries.length);
                    
                    if (equipmentEntries.length === 0) {
                        this.showNoData(equipmentName);
                        return;
                    }
                    
                    // Sort by date to get the latest entry
                    const latestEntry = this.getLatestEntry(equipmentEntries);
                    this.displayEquipmentStatus(latestEntry, equipmentName);
                    
                } catch (error) {
                    console.error('Error loading equipment data:', error);
                    this.showError(`Kunne ikke laste data fra regnearket: ${error.message}`);
                }
            }
            
            async fetchDataFromAPI() {
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CONFIG.SPREADSHEET_ID,
                    range: CONFIG.SHEET_RANGE
                });
                
                const values = response.result.values;
                if (!values || values.length === 0) {
                    return [];
                }
                
                // Convert to object format
                const headers = values[0];
                const data = [];
                
                for (let i = 1; i < values.length; i++) {
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[i][index] || '';
                    });
                    data.push(row);
                }
                
                return data;
            }
            
            async fetchDataFromCSV() {
                const csvUrl = `https://docs.google.com/spreadsheets/d/${CONFIG.SPREADSHEET_ID}/export?format=csv&gid=${CONFIG.CSV_GID}`;
                
                console.log('Fetching CSV from:', csvUrl);
                
                try {
                    const response = await fetch(csvUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    const csvText = await response.text();
                    console.log('CSV data received, length:', csvText.length);
                    
                    if (!csvText || csvText.trim() === '') {
                        throw new Error('Empty CSV response');
                    }
                    
                    return this.csvToJson(csvText);
                } catch (error) {
                    console.error('CSV fetch error:', error);
                    // If CORS or network error, provide helpful message
                    if (error.message.includes('CORS') || error.message.includes('fetch')) {
                        throw new Error('Nettverksfeil - sjekk at regnearket er publisert og tilgjengelig');
                    }
                    throw error;
                }
            }
            
            csvToJson(csvText) {
                const lines = csvText.split('\n').filter(line => line.trim() !== '');
                if (lines.length === 0) return [];

                const headers = this.parseCSVLine(lines[0]);
                const result = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = this.parseCSVLine(lines[i]);
                    if (values.length === 0) continue;

                    const row = {};
                    headers.forEach((header, index) => {
                        row[header.trim()] = values[index]?.trim() || '';
                    });
                    result.push(row);
                }

                return result;
            }
            
            parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;

                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    const nextChar = line[i + 1];
                    
                    if (char === '"') {
                        if (inQuotes && nextChar === '"') {
                            current += '"';
                            i++; // Skip the next quote
                        } else {
                            inQuotes = !inQuotes;
                        }
                    } else if (char === ',' && !inQuotes) {
                        result.push(current);
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current);
                return result;
            }
            
            getLatestEntry(entries) {
                // Try to sort by date columns
                return entries.sort((a, b) => {
                    // Look for date columns
                    const dateColumns = ['Dato', 'Date', 'Timestamp', 'Tidsstempel'];
                    
                    for (const col of dateColumns) {
                        if (a[col] && b[col]) {
                            const dateA = new Date(a[col]);
                            const dateB = new Date(b[col]);
                            
                            if (!isNaN(dateA) && !isNaN(dateB)) {
                                return dateB - dateA; // Latest first
                            }
                        }
                    }
                    
                    // Fallback: use first entry
                    return 0;
                })[0];
            }
            
            displayEquipmentStatus(entry, equipmentName) {
                // Determine status
                const status = this.determineStatus(entry);
                
                // Update last updated time
                const lastUpdated = this.getLastUpdatedDate(entry);
                document.getElementById('lastUpdated').textContent = `Sist oppdatert: ${lastUpdated}`;
                
                // Create status display
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="status-card">
                        <div class="status-indicator">
                            <div class="status-dot ${status.class}"></div>
                            <div class="status-text">${status.text}</div>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Status</span>
                            <span class="info-value">${entry['Status'] || entry['Tilstand'] || 'Ikke spesifisert'}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Kontrollert av</span>
                            <span class="info-value">${entry['Kontrollert av'] || entry['Checked by'] || entry['Navn'] || 'Ukjent'}</span>
                        </div>
                        
                        <div class="info-row">
                            <span class="info-label">Dato</span>
                            <span class="info-value">${lastUpdated}</span>
                        </div>
                        
                        ${this.createFaultSection(entry)}
                    </div>
                    
                    <a href="${this.createFormLink(equipmentName)}" class="action-button">
                        Registrer ny kontroll
                    </a>
                `;
            }
            
            determineStatus(entry) {
                const statusText = (entry['Status'] || entry['Tilstand'] || '').toLowerCase();
                const fault = entry['Feil'] || entry['Fault'] || entry['Problem'] || '';
                
                if (fault && fault.toLowerCase() !== 'nei' && fault.toLowerCase() !== 'no' && fault.trim() !== '') {
                    return { class: 'fault', text: 'Feil registrert' };
                }
                
                if (statusText.includes('ok') || statusText.includes('bra') || statusText.includes('fungerer')) {
                    return { class: 'ok', text: 'Fungerer' };
                }
                
                if (statusText.includes('feil') || statusText.includes('defekt') || statusText.includes('Ã¸delagt')) {
                    return { class: 'fault', text: 'Feil registrert' };
                }
                
                return { class: 'unknown', text: 'Status ukjent' };
            }
            
            createFaultSection(entry) {
                const fault = entry['Feil'] || entry['Fault'] || entry['Problem'] || '';
                
                if (!fault || fault.toLowerCase() === 'nei' || fault.toLowerCase() === 'no' || fault.trim() === '') {
                    return '';
                }
                
                return `
                    <div class="fault-section">
                        <div class="fault-title">Registrert feil:</div>
                        <div class="fault-text">${fault}</div>
                    </div>
                `;
            }
            
            getLastUpdatedDate(entry) {
                const dateColumns = ['Dato', 'Date', 'Timestamp', 'Tidsstempel'];
                
                for (const col of dateColumns) {
                    if (entry[col]) {
                        const date = new Date(entry[col]);
                        if (!isNaN(date)) {
                            return date.toLocaleDateString('no-NO', {
                                year: 'numeric',
                                month: 'short',
                                day: 'numeric',
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        }
                    }
                }
                
                return 'Ukjent dato';
            }
            
            createFormLink(equipmentName) {
                return `${CONFIG.FORM_URL}?usp=pp_url&${CONFIG.FORM_PREFILL_PARAM}=${encodeURIComponent(equipmentName)}`;
            }
            
            showError(message) {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="error">
                        <strong>Feil:</strong> ${message}
                    </div>
                `;
            }
            
            showNoData(equipmentName) {
                const content = document.getElementById('content');
                content.innerHTML = `
                    <div class="no-data">
                        <p>Ingen data funnet for <strong>${equipmentName}</strong></p>
                        <a href="${this.createFormLink(equipmentName)}" class="action-button">
                            Registrer fÃ¸rste kontroll
                        </a>
                    </div>
                `;
            }
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new EquipmentStatus();
        });
    </script>
</body>
</html>